<!--
 * Copyright (c) 2022, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * WSO2 Inc. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 -->

<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="referrer" content="no-referrer" />

    <title>Simple Shop</title>

    <link href="app.css" rel="stylesheet" type="text/css" />

    <style type="text/css">
        .json-formatter-row .json-formatter-string,
        .json-formatter-row .json-formatter-stringifiable {
            white-space: unset !important;
        }

        .json-formatter-dark.json-formatter-row .json-formatter-row {
            line-height: 1.5;
        }

        .json-container {
            background: #272822;
            padding: 20px;
        }

        .json-formatter-string {
            color: #fd971f !important;
        }

        .json-formatter-key,
        .json-formatter-bracket {
            color: #f9f8f5 !important;
            letter-spacing: 0.5px;
        }

        .json-formatter-number {
            color: #cc6633 !important;
        }

        .code {
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="container">
            <div class="header-title">
                <h1>Simple Shop</h1>
            </div>
            <div class="content">
                <% if (error) { %>
                    <div id="error">
                        <div class="segment-form">
                            <div class="ui visible negative message">
                                <div class="header"><b>Authentication Error!</b></div>
                                <p>Something went wrong during the authentication process.</p>
                            </div>
                        </div>
                    </div>
                    <% } %>
                        <% if(!isConfigPresent) { %>
                            <div id="missing-config">
                                <h2>You need to update the Client ID to proceed.</h2>
                                <p>
                                    Please open the <b>index.html</b> file using an editor and scroll down to the
                                    <b>script</b> tag at the the end of the <b>body</b> tag, find the
                                    <code>authConfig</code>,
                                    and update the <code>clientID</code> value with the registered application's client
                                    ID.
                                </p>
                                <p>
                                    Visit repo
                                    <a
                                        href="https://github.com/asgardeo/asgardeo-auth-node-sdk/tree/master/samples/asgardeo-express-app">
                                        README
                                    </a>
                                    for more details.
                                </p>
                            </div>
                            <% } else if (isAuthenticated && idToken) { %>
                                <div id="loading">Loading ...</div>
                                <div id="logged-in-view" style="display:none;">
                                    <div class="top-buttons">
                                        <form action="auth/logout">
                                            <button class="btn primary mt-4 no-margin" type="submit">Logout</button>
                                        </form>
                                    </div>
                                    <h2 class="mb-0">MY ORDERS</h2>
                                    <h4 className="sub-title mt-0">Hello hello@suvin.me</h4>

                                    <img src="images/order.png" class="order-image" />

                                    <div class="json">
                                        <div id="authentication-response" class="json-container"></div>
                                    </div>
                                </div>

                                <% } else { %>

                                    <div id="logged-out-view">
                                        <div class="top-buttons">
                                            <form action="auth/login">
                                                <button class="btn primary" type="submit">My Account</button>
                                            </form>
                                        </div>
                                        <div class="product-cards">
                                            <div class="card">
                                                <div class="image-wrapper">
                                                    <img src="https://fakestoreapi.com/img/71-3HjGNDUL._AC_SY879._SX._UX._SY._UY_.jpg"
                                                        alt="" class="image" />
                                                </div>
                                                <div class="content-wrapper">
                                                    <h2>Folk-tastic Pennant</h2>
                                                    <p>Your perfect pack for everyday use and walks in the forest. Stash
                                                        your laptop (up to 15 inches) in the padded sleeve, your
                                                        everyday</p>
                                                    <button class="btn secondary">Add to Cart</button>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="image-wrapper">
                                                    <img src="https://fakestoreapi.com/img/71li-ujtlUL._AC_UX679_.jpg"
                                                        alt="" class="image" />
                                                </div>
                                                <div class="content-wrapper">
                                                    <h2>Mens Cotton Jacket</h2>
                                                    <p>Your perfect pack for everyday use and walks in the forest. Stash
                                                        your laptop (up to 15 inches) in the padded sleeve, your
                                                        everyday</p>
                                                    <button class="btn secondary">Add to Cart</button>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="image-wrapper">
                                                    <img src="https://fakestoreapi.com/img/71z3kpMAYsL._AC_UY879_.jpg"
                                                        alt="" class="image" />
                                                </div>
                                                <div class="content-wrapper">
                                                    <h2>Women's Solid Short</h2>
                                                    <p>Your perfect pack for everyday use and walks in the forest. Stash
                                                        your laptop (up to 15 inches) in the padded sleeve, your
                                                        everyday</p>
                                                    <button class="btn secondary">Add to Cart</button>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="image-wrapper">
                                                    <img src="https://fakestoreapi.com/img/51eg55uWmdL._AC_UX679_.jpg"
                                                        alt="" class="image" />
                                                </div>
                                                <div class="content-wrapper">
                                                    <h2>Women's Short Sleeve Moisture</h2>
                                                    <p>Your perfect pack for everyday use and walks in the forest. Stash
                                                        your laptop (up to 15 inches) in the padded sleeve, your
                                                        everyday</p>
                                                    <button class="btn secondary">Add to Cart</button>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <% } %>
            </div>
        </div>

        <img src="images/footer.png" class="footer-image" />
    </div>

    <!-- Add Asgardeo OIDC JS -->
    <script src="https://unpkg.com/json-formatter-js@latest/dist/json-formatter.umd.js"></script>
    <script>
        function parseIdToken(idToken) {
            if (!idToken) {
                return;
            }

            if (typeof idToken !== "string") {
                idToken = JSON.stringify(idToken);
            }

            const idTokenSplit = idToken.split(".");
            let idTokenObject = {
                encoded: [],
                decoded: []
            };

            idTokenSplit.forEach(function (element) {
                idTokenObject["encoded"].push(element);
            });

            idTokenObject["decoded"].push(JSON.parse(atob(idTokenObject.encoded[0])));
            idTokenObject["decoded"].push(JSON.parse(atob(idTokenObject.encoded[1])));

            var sub = idTokenObject["decoded"][1] && idTokenObject["decoded"][1]?.sub?.split("/");

            if (sub.length >= 2) {
                sub.shift();
                idTokenObject["decoded"][1].sub = sub.join("/");
            }

            const groups = [];
            idTokenObject["decoded"][1] &&
                typeof idTokenObject["decoded"][1]?.groups === "string" &&
                groups.push(idTokenObject["decoded"][1]?.groups);

            idTokenObject["decoded"][1] &&
                typeof idTokenObject["decoded"][1]?.groups !== "string" &&
                idTokenObject["decoded"][1]?.groups?.forEach((group) => {
                    const groupArrays = group.split("/");

                    if (groupArrays.length >= 2) {
                        groupArrays.shift();
                        groups.push(groupArrays.join("/"));
                    } else {
                        groups.push(group);
                    }
                });

            if (idTokenObject["decoded"][1]?.groups) {
                idTokenObject["decoded"][1].groups = groups;
            }

            return idTokenObject;
        }

        var idToken = "<%=idToken%>";
        var authenticationResponseViewBox = document.getElementById("authentication-response");

        if ("<%=isAuthenticated%>" === "true" && idToken) {
            document.getElementById("logged-in-view").style.display = "block";
            document.getElementById("loading").style.display = "none";

        }
    </script>
</body>

</html>